@{
    ViewData["Title"] = "AI Chat";
}

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-comments me-2"></i>AI Chat Assistant
                </h4>
            </div>
            <div class="card-body p-0">
                <!-- Chat Messages -->
                <div id="chat-messages" class="chat-container p-3" role="log" aria-live="polite" aria-label="Chat messages">
                    <div class="chat-message assistant">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <p>Hello! I'm your NYC Virtual Citizen Assistant. How can I help you today?</p>
                            <p class="text-muted small">Try asking about parking permits, business licenses, housing, or other NYC services.</p>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="border-top p-3">
                    <form id="chat-form" class="d-flex gap-2">
                        <label for="message-input" class="visually-hidden">Your message</label>
                        <input type="text" id="message-input" class="form-control"
                               placeholder="Type your question here..."
                               aria-describedby="input-help"
                               maxlength="10000" required />
                        <button type="submit" class="btn btn-primary" id="send-btn" aria-label="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <small id="input-help" class="text-muted">Press Enter to send</small>
                </div>
            </div>
        </div>

        <!-- Session Info -->
        <div class="mt-3 text-center">
            <small class="text-muted">
                Session ID: <span id="session-id">New session</span>
                <button class="btn btn-link btn-sm" id="new-session-btn" aria-label="Start new session">
                    <i class="fas fa-redo"></i> New Session
                </button>
            </small>
        </div>
    </div>
</div>

@section Scripts {
<style>
    .chat-container {
        height: 500px;
        overflow-y: auto;
        background-color: #f8f9fa;
    }

    .chat-message {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        animation: fadeIn 0.3s ease;
    }

    .chat-message.user {
        flex-direction: row-reverse;
    }

    .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .chat-message.assistant .message-avatar {
        background-color: #0d6efd;
        color: white;
    }

    .chat-message.user .message-avatar {
        background-color: #6c757d;
        color: white;
    }

    .message-content {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 15px;
    }

    .chat-message.assistant .message-content {
        background-color: white;
        border: 1px solid #dee2e6;
    }

    .chat-message.user .message-content {
        background-color: #0d6efd;
        color: white;
    }

    .message-content p:last-child {
        margin-bottom: 0;
    }

    .sources-list {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #dee2e6;
    }

    .source-badge {
        display: inline-block;
        background-color: #e9ecef;
        padding: 4px 8px;
        border-radius: 4px;
        margin: 2px;
        font-size: 0.85em;
    }

    .source-badge:hover {
        background-color: #dee2e6;
    }

    .typing-indicator {
        display: flex;
        gap: 4px;
        padding: 10px;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #6c757d;
        border-radius: 50%;
        animation: typing 1s infinite;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @@keyframes typing {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<script>
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMessages = document.getElementById('chat-messages');
    const sessionIdSpan = document.getElementById('session-id');
    const newSessionBtn = document.getElementById('new-session-btn');
    const sendBtn = document.getElementById('send-btn');

    let sessionId = null;

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, 'user');
        messageInput.value = '';
        sendBtn.disabled = true;

        // Show typing indicator
        showTypingIndicator();

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sessionId, message })
            });

            const data = await response.json();
            hideTypingIndicator();

            if (response.ok) {
                sessionId = data.sessionId;
                sessionIdSpan.textContent = sessionId.substring(0, 8) + '...';
                addMessage(data.content, 'assistant', data.sources);
            } else {
                addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
            }
        } catch (error) {
            hideTypingIndicator();
            addMessage('Sorry, I could not connect to the server. Please try again.', 'assistant');
        }

        sendBtn.disabled = false;
        messageInput.focus();
    });

    newSessionBtn.addEventListener('click', () => {
        sessionId = null;
        sessionIdSpan.textContent = 'New session';
        chatMessages.innerHTML = `
            <div class="chat-message assistant">
                <div class="message-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-content">
                    <p>Hello! I'm your NYC Virtual Citizen Assistant. How can I help you today?</p>
                </div>
            </div>
        `;
    });

    function addMessage(content, role, sources = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${role}`;

        const icon = role === 'assistant' ? 'fa-robot' : 'fa-user';
        let sourcesHtml = '';

        if (sources && sources.length > 0) {
            sourcesHtml = `
                <div class="sources-list">
                    <small class="text-muted"><i class="fas fa-quote-left"></i> Sources:</small><br>
                    ${sources.map(s => `<a href="${s.url}" class="source-badge text-decoration-none" target="_blank">${s.title}</a>`).join('')}
                </div>
            `;
        }

        messageDiv.innerHTML = `
            <div class="message-avatar"><i class="fas ${icon}"></i></div>
            <div class="message-content">
                <p>${escapeHtml(content)}</p>
                ${sourcesHtml}
            </div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'chat-message assistant';
        indicator.innerHTML = `
            <div class="message-avatar"><i class="fas fa-robot"></i></div>
            <div class="message-content">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatMessages.appendChild(indicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function hideTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Keyboard shortcuts
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            chatForm.dispatchEvent(new Event('submit'));
        }
    });
</script>
}
